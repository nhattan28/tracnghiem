<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tr·∫Øc Nghi·ªám Th√∫ V·ªã</title>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/confetti-js@0.0.18/dist/index.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #6ee7b7, #3b82f6, #8b5cf6, #ec4899);
      background-size: 400% 400%;
      animation: gradientFlow 12s ease infinite;
      color: #1f2937;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    @keyframes gradientFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .container {
      width: 95%;
      max-width: 1200px;
      margin: 1.5rem auto;
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease;
    }

    .container:hover {
      transform: translateY(-5px);
    }

    h2 {
      text-align: center;
      color: #1e40af;
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .note {
      background: linear-gradient(to right, #fefcbf, #fef3c7);
      padding: 1rem;
      border-left: 6px solid #f59e0b;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
      font-size: 1 rem;
      line-height: 1.5;
    }

    .question-block {
      display: none;
      border-radius: 1rem;
      background: linear-gradient(-45deg, #fef3c7, #fed7aa, #fecaca, #f3e8ff);
      background-size: 400% 400%;
      animation: glow 10s ease infinite;
      padding: 1.5rem;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
    }

    @keyframes glow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    button {
      background: linear-gradient(to right, #ec4899, #8b5cf6);
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 1rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #startQuiz button {
      font-size: 1.5rem;
      padding: 1rem 2.5rem;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 15px rgba(255, 107, 107, 0.5);
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    #startQuiz button:hover {
      animation: none;
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    #optionsContainer label {
      display: flex;
      align-items: center;
      margin-bottom: 0.75rem;
      background: rgba(255, 255, 255, 0.9);
      padding: 0.75rem;
      border-radius: 0.5rem;
      cursor: pointer;
      border: 2px solid #e5e7eb;
      transition: border-color 0.3s ease, background 0.3s ease;
    }

    #optionsContainer label:hover {
      border-color: #8b5cf6;
      background: rgba(255, 255, 255, 1);
    }

    input[type="file"] {
      margin: 1rem 0;
      padding: 0.5rem;
      border: 2px dashed #d1d5db;
      border-radius: 0.5rem;
      width: 100%;
      background: #f9fafb;
    }

    .result {
      margin-top: 2rem;
      background: #ecfdf5;
      padding: 1.5rem;
      border-radius: 0.75rem;
      border-left: 6px solid #10b981;
    }

    .correct { color: #15803d; font-weight: 600; }
    .wrong { color: #dc2626; font-weight: 600; }

    canvas#confetti {
      position: fixed;
      top: 0;
      left: 0;
      pointer-events: none;
      width: 100vw;
      height: 100vh;
      z-index: 9999;
    }

    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      z-index: 99999;
      text-align: center;
      max-width: 90%;
      width: 400px;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 99998;
    }

    #timer {
      text-align: center;
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #1e40af;
    }

    .button-group-wrapper {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1.5rem;
      align-items: center;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
    }

    #scalePopup input {
      padding: 0.75rem;
      margin: 0.75rem 0;
      border-radius: 0.5rem;
      border: 2px solid #d1d5db;
      width: 100%;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    #scalePopup input:focus {
      border-color: #8b5cf6;
      outline: none;
    }

    @media (min-width: 640px) {
      .container {
        width: 90%;
        padding: 2rem;
      }
      h2 {
        font-size: 2.5rem;
      }
      .button-group-wrapper {
        flex-direction: row;
        justify-content: center;
      }
    }

    @media (min-width: 1024px) {
      .container {
        width: 80%;
      }
      .question-block {
        padding: 2rem;
      }
    }

    @media (min-width: 1280px) {
      .container {
        width: 70%;
      }
    }

    #countdown {
      display: none;
      text-align: center;
      font-size: 2rem;
      font-weight: 700;
      color: #ec4899;
      margin-top: 1rem;
      text-shadow: 0 0 10px rgba(236, 72, 153, 0.7);
    }
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>
  <div class="container">
    <h2>üåü Tr·∫Øc Nghi·ªám Th√∫ V·ªã üåü</h2>
    <div id="noteSection" class="note">
      üìå <strong>L∆∞u √Ω:</strong> ƒê√°p √°n ƒë√∫ng c·∫ßn <strong>in ƒë·∫≠m</strong> trong file Word.<br>
      ƒê·ªãnh d·∫°ng c√¢u h·ªèi: <code>1.</code> ho·∫∑c <code>1)</code><br>
      ƒê·ªãnh d·∫°ng c√¢u tr·∫£ l·ªùi: <code>a.</code> ho·∫∑c <code>a)</code> ho·∫∑c <code>A.</code> ho·∫∑c <code>A)</code><br>
      Ho·∫∑c ·∫•n v√†o "Chu·∫©n h√≥a c√¢u h·ªèi" ƒë·ªÉ l√†m chu·∫©n c√¢u h·ªèi cho trang website
    </div>

    <input type="file" id="upload" accept=".docx" />
    <div id="startQuiz" class="text-center mt-4" style="display:none;">
      <button onclick="startCountdown()">üéØ B·∫Øt ƒë·∫ßu Tr·∫Øc Nghi·ªám</button>
    </div>
    <div id="countdown"></div>

    <div id="timer"></div>
    <div id="quizContainer" class="question-block">
      <div id="questionText" class="text-lg font-semibold mb-4"></div>
      <div id="optionsContainer" class="space-y-3"></div>
      <div class="flex justify-between items-center mt-6 flex-wrap gap-3">
        <div class="flex gap-3">
          <button onclick="prevQuestion()">‚¨ÖÔ∏è Quay l·∫°i</button>
          <button onclick="nextQuestion()">‚û°Ô∏è Ti·∫øp theo</button>
        </div>
        <button onclick="submitQuiz()">N·ªôp b√†i</button>
      </div>
    </div>

    <div id="progressBar" class="mt-6 font-semibold text-center text-lg text-gray-700">0 / 0 c√¢u ƒë√£ l√†m</div>
    <div class="button-group-wrapper">
      <div class="button-row">
        <button onclick="window.location.href='chuyendoi.html'">Chu·∫©n h√≥a c√¢u h·ªèi</button>
        <button onclick="window.location.href='chuyenword.html'">Chu·∫©n sang Word</button>
        <button id="clearFileBtn" style="display:none;" onclick="clearFile()">üóëÔ∏è X√≥a file</button>
      </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="popup" id="popup">
      <div id="popupMessage" class="text-lg font-medium"></div>
      <div id="popupButtons" class="mt-4"></div>
    </div>
    <div class="popup" id="scalePopup">
      <div id="scalePopupMessage" class="text-lg font-medium">Nh·∫≠p thang ƒëi·ªÉm (1-100):</div>
      <input type="number" id="scaleInput" min="1" max="100" placeholder="Thang ƒëi·ªÉm" required>
      <div id="scalePopupButtons" class="mt-4">
        <button onclick="saveScale()">X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>

  <script>
    const encouragements = [
      "ƒê·ª´ng n·∫£n, b·∫°n ƒëang l√†m r·∫•t t·ªët! üí™",
      "Th·ª≠ l·∫°i nh√©, b·∫°n s·∫Ω l√†m ƒë∆∞·ª£c! üåü",
      "M·ªói l·∫ßn sai l√† m·ªôt l·∫ßn h·ªçc! üìò",
      "B·∫°n ƒëang ti·∫øn b·ªô ƒë·∫•y! üöÄ",
      "Gi·ªØ v·ªØng tinh th·∫ßn nh√©! üíñ"
    ];

    let rawQuestions = [], current = 0, userAnswers = [], quizStarted = false;
    let timerInterval = null, totalSeconds = 0, scale = 10;
    const confetti = new ConfettiGenerator({ target: 'confetti' });

    // Check if there's existing quiz data on page load
    window.onload = function() {
      const savedQuestions = localStorage.getItem("quizQuestions");
      const restartFlag = localStorage.getItem("restartQuiz");
      if (savedQuestions) {
        rawQuestions = JSON.parse(savedQuestions);
        if (rawQuestions.length > 0) {
          document.getElementById("upload").style.display = "none";
          document.getElementById("noteSection").style.display = "none";
          document.getElementById("clearFileBtn").style.display = "inline-block";
          if (restartFlag === "true") {
            // Clear the restart flag
            localStorage.removeItem("restartQuiz");
            // Prompt for scale and start quiz
            document.getElementById("overlay").style.display = "block";
            document.getElementById("scalePopup").style.display = "block";
          }
        }
      }
    };

    document.getElementById("upload").addEventListener("change", function (event) {
      const reader = new FileReader();
      reader.onload = function () {
        mammoth.convertToHtml({ arrayBuffer: reader.result }).then(function (result) {
          const html = result.value;
          parseQuestions(html);
          if (rawQuestions.length > 0) {
            // Save to localStorage
            localStorage.setItem("quizQuestions", JSON.stringify(rawQuestions));
            document.getElementById("upload").style.display = "none";
            document.getElementById("noteSection").style.display = "none";
            document.getElementById("clearFileBtn").style.display = "inline-block";
            document.getElementById("overlay").style.display = "block";
            document.getElementById("scalePopup").style.display = "block";
          } else {
            showPopup("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi h·ª£p l·ªá.");
          }
        }).catch(() => {
          showPopup("‚ùå L·ªói ƒë·ªçc file.");
        });
      };
      if (event.target.files.length > 0) reader.readAsArrayBuffer(event.target.files[0]);
    });

    function parseQuestions(html) {
      const container = document.createElement("div");
      container.innerHTML = html;
      const paras = container.querySelectorAll("p");
      rawQuestions = [];
      let currentQ = null;

      function isRedOrBold(p) {
        let hasRed = false;
        let hasBold = false;
        p.querySelectorAll("*").forEach(el => {
          const style = el.getAttribute("style") || "";
          const colorRed = /color:\s*(red|#ff0000)/i.test(style);
          const tagBold = el.tagName === "B" || el.tagName === "STRONG";
          if (colorRed) hasRed = true;
          if (tagBold) hasBold = true;
        });
        return hasRed || hasBold;
      }

      paras.forEach(p => {
        const text = p.innerText.trim();
        if (/^\d+[\.\)]\s/.test(text)) {
          if (currentQ) rawQuestions.push(currentQ);
          currentQ = { question: text, options: [], correctIndex: null };
        } else if (/^[a-dA-D][\.\)]\s/.test(text) && currentQ) {
          const label = text.substring(0, 2);
          const content = text.substring(2).trim();
          const full = label + " " + content;
          const isCorrect = isRedOrBold(p);
          currentQ.options.push({ text: full, isCorrect });
        }
      });

      if (currentQ) rawQuestions.push(currentQ);
    }

    function saveScale() {
      const scaleInput = document.getElementById("scaleInput");
      const value = parseInt(scaleInput.value);
      if (value >= 1 && value <= 100) {
        scale = value;
        document.getElementById("scalePopup").style.display = "none";
        document.getElementById("overlay").style.display = "none";
        // Show the message popup, but don't show the start button yet
        showPopup("Nh·∫•n 'B·∫Øt ƒë·∫ßu' ƒë·ªÉ l√†m b√†i! Kh√¥ng ƒë∆∞·ª£c chuy·ªÉn tab, chuy·ªÉn ·ª©ng d·ª•ng ho·∫∑c thu nh·ªè tr√¨nh duy·ªát. M·ªói c√¢u h·ªèi b·∫Øt bu·ªôc ph·∫£i ch·ªçn ƒë√°p √°n m·ªõi ƒë∆∞·ª£c ti·∫øp t·ª•c.", false, startCountdown);
      } else {
        showPopup("Thang ƒëi·ªÉm ph·∫£i t·ª´ 1 ƒë·∫øn 100.");
      }
    }

    function startCountdown() {
      const countdownElement = document.getElementById("countdown");
      countdownElement.style.display = "block";

      let count = 3;
      countdownElement.textContent = count;

      const countdownInterval = setInterval(() => {
        count--;
        if (count > 0) {
          countdownElement.textContent = count;
        } else {
          clearInterval(countdownInterval);
          countdownElement.style.display = "none";
          startQuiz();
        }
      }, 1000);
    }

    function startQuiz() {
      quizStarted = true;
      shuffleArray(rawQuestions);
      rawQuestions.forEach(q => {
        shuffleArray(q.options);
        q.correctIndex = q.options.findIndex(opt => opt.isCorrect);
      });
      document.getElementById("startQuiz").style.display = "none";
      document.getElementById("quizContainer").style.display = "block";
      document.getElementById("countdown").style.display = "none";
      userAnswers = [];
      current = 0;
      totalSeconds = 0;
      startTimer();
      showQuestion();
    }

    function showQuestion() {
      const q = rawQuestions[current];
      document.getElementById("questionText").innerHTML = `<h3 class="text-xl font-semibold">${q.question}</h3>`;
      const optContainer = document.getElementById("optionsContainer");
      optContainer.innerHTML = "";
      q.options.forEach((opt, idx) => {
        optContainer.innerHTML += `<label><input type="radio" name="option" value="${idx}" class="mr-2"> ${opt.text}</label>`;
      });

      // Add event listeners to radio buttons for auto-advance
      const radioButtons = document.querySelectorAll('input[name="option"]');
      radioButtons.forEach(radio => {
        radio.addEventListener('change', () => {
          nextQuestion();
        });
      });

      updateProgress();
    }

    function nextQuestion() {
      const selected = document.querySelector('input[name="option"]:checked');
      if (!selected) return showPopup("B·∫°n ph·∫£i ch·ªçn m·ªôt ƒë√°p √°n.");
      userAnswers.push(parseInt(selected.value));
      current++;
      if (current < rawQuestions.length) {
        showQuestion();
      } else {
        stopTimer();
        showResult();
      }
    }

    function updateProgress() {
      document.getElementById("progressBar").textContent = `${current} / ${rawQuestions.length} c√¢u ƒë√£ l√†m`;
    }

    function showResult() {
      quizStarted = false;
      let correct = 0;
      const wrongAnswers = [];

      rawQuestions.forEach((q, i) => {
        if (userAnswers[i] === q.correctIndex) {
          correct++;
        } else {
          wrongAnswers.push({
            question: q.question,
            selected: q.options[userAnswers[i]]?.text || "Kh√¥ng ch·ªçn",
            correct: q.options[q.correctIndex]?.text || "Kh√¥ng x√°c ƒë·ªãnh"
          });
        }
      });

      const score = ((correct / rawQuestions.length) * scale).toFixed(2);
      localStorage.setItem("quizScore", score);
      localStorage.setItem("quizCorrect", correct);
      localStorage.setItem("quizTotal", rawQuestions.length);
      localStorage.setItem("quizTime", formatTime(totalSeconds));
      localStorage.setItem("quizWrongAnswers", JSON.stringify(wrongAnswers));
      localStorage.setItem("quizScale", scale);

      window.location.href = "ketqua.html";
    }

    function restartQuiz() {
      document.getElementById("result").innerHTML = "";
      document.getElementById("quizContainer").style.display = "block";
      shuffleArray(rawQuestions);
      rawQuestions.forEach(q => {
        shuffleArray(q.options);
        q.correctIndex = q.options.findIndex(opt => opt.isCorrect);
      });
      userAnswers = [];
      current = 0;
      totalSeconds = 0;
      quizStarted = true;
      startTimer();
      showQuestion();
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function startTimer() {
      timerInterval = setInterval(() => {
        totalSeconds++;
        document.getElementById("timer").textContent = `‚è±Ô∏è Th·ªùi gian: ${formatTime(totalSeconds)}`;
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      document.getElementById("timer").textContent = '';
    }

    function formatTime(s) {
      const m = Math.floor(s / 60).toString().padStart(2, '0');
      const sec = (s % 60).toString().padStart(2, '0');
      return `${m}:${sec}`;
    }

    document.addEventListener("visibilitychange", () => {
      if (quizStarted && document.hidden) {
        quizStarted = false;
        stopTimer();
        showPopup("B·∫°n ƒë√£ chuy·ªÉn tab ho·∫∑c thu nh·ªè c·ª≠a s·ªï. B√†i l√†m ƒë√£ k·∫øt th√∫c.");
        document.getElementById("quizContainer").style.display = "none";
      }
    });

    window.addEventListener("resize", () => {
      if (quizStarted && window.outerWidth < 800) {
        quizStarted = false;
        stopTimer();
        showPopup("B·∫°n ƒë√£ thu nh·ªè c·ª≠a s·ªï. B√†i l√†m ƒë√£ k·∫øt th√∫c.");
        document.getElementById("quizContainer").style.display = "none";
      }
    });

    function showPopup(message, confirm = false, onOkCallback = closePopup) {
      const overlay = document.getElementById("overlay");
      const popup = document.getElementById("popup");
      const messageDiv = document.getElementById("popupMessage");
      const buttons = document.getElementById("popupButtons");

      messageDiv.textContent = message;
      overlay.style.display = "block";
      popup.style.display = "block";
      buttons.innerHTML = "";

      if (confirm) {
        const yesBtn = document.createElement("button");
        yesBtn.textContent = "C√≥";
        yesBtn.onclick = () => { closePopup(); restartQuiz(); };
        const noBtn = document.createElement("button");
        noBtn.textContent = "Kh√¥ng";
        noBtn.onclick = closePopup;
        buttons.appendChild(yesBtn);
        buttons.appendChild(noBtn);
      } else {
        const okBtn = document.createElement("button");
        okBtn.textContent = "OK";
        okBtn.onclick = () => {
          closePopup();
          onOkCallback();
        };
        buttons.appendChild(okBtn);
      }
    }

    function closePopup() {
      document.getElementById("popup").style.display = "none";
      document.getElementById("overlay").style.display = "none";
    }

    function prevQuestion() {
      if (current === 0) {
        showPopup("B·∫°n ƒëang ·ªü c√¢u ƒë·∫ßu ti√™n.");
        return;
      }
      current--;
      userAnswers.pop();
      showQuestion();
    }

    function clearFile() {
      document.getElementById("upload").value = "";
      rawQuestions = [];
      userAnswers = [];
      current = 0;
      scale = 10;
      // Clear stored quiz data
      localStorage.removeItem("quizQuestions");
      document.getElementById("startQuiz").style.display = "none";
      document.getElementById("quizContainer").style.display = "none";
      document.getElementById("progressBar").textContent = "0 / 0 c√¢u ƒë√£ l√†m";
      document.getElementById("timer").textContent = '';
      stopTimer();
      document.getElementById("upload").style.display = "block";
      document.getElementById("noteSection").style.display = "block";
      document.getElementById("clearFileBtn").style.display = "none";
      document.getElementById("scalePopup").style.display = "none";
      document.getElementById("overlay").style.display = "none";
    }

    function submitQuiz() {
      const selected = document.querySelector('input[name="option"]:checked');
      if (userAnswers.length < rawQuestions.length) {
        if (selected) userAnswers.push(parseInt(selected.value));
        for (let i = userAnswers.length; i < rawQuestions.length; i++) {
          userAnswers.push(null);
        }
      }

      stopTimer();
      showResult();
    }
  </script>
</body>
</html>
